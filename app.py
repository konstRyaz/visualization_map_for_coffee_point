import streamlit as st
import folium
import numpy as np
import pandas as pd
from folium.plugins import HeatMap

# --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
st.set_page_config(layout="wide")
st.title("–ö–∞—Ä—Ç–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è POI")
st.write("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö POI —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º–∏ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏.")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö POI ---
@st.cache_data
def load_and_process_pois(filepath):
    df = pd.read_csv(filepath)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫: lat, lon, score
    required_columns = ['lat', 'lon', 'score']
    for col in required_columns:
        if col not in df.columns:
            st.error(f"–û—à–∏–±–∫–∞: –í—Ö–æ–¥–Ω–æ–π CSV —Ñ–∞–π–ª '{filepath}' –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü '{col}'.")
            st.stop()

    df = df.dropna(subset=['lat', 'lon', 'score'])
    df = df.rename(columns={'lat': 'latitude', 'lon': 'longitude'})

    return df

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ø–æ —Å–∫–æ—Ä—É (–¥–ª—è –∫—Ä—É–≥–æ–≤) ---
def get_gradient_color(score, min_score, max_score):
    if max_score == min_score:
        normalized_score = 0.5
    else:
        normalized_score = (score - min_score) / (max_score - min_score)

    normalized_score = max(0.0, min(1.0, normalized_score))

    if normalized_score < 0.5:
        r = 1
        g = normalized_score * 2
        b = 0
    else:
        r = 1 - (normalized_score - 0.5) * 2
        g = 1
        b = 0
    return f'#{int(r*255):02x}{int(g*255):02x}{int(b*255):02x}'


# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è session_state –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ---
if 'radius_meters' not in st.session_state: st.session_state.radius_meters = 150
if 'fill_opacity_value' not in st.session_state: st.session_state.fill_opacity_value = 0.4
if 'heatmap_radius' not in st.session_state: st.session_state.heatmap_radius = 20
if 'heatmap_blur' not in st.session_state: st.session_state.heatmap_blur = 15
if 'heatmap_min_opacity' not in st.session_state: st.session_state.heatmap_min_opacity = 0.3
if 'heatmap_max_opacity' not in st.session_state: st.session_state.heatmap_max_opacity = 0.8
if 'min_score_filter' not in st.session_state: st.session_state.min_score_filter = 0.1
if 'city_selection' not in st.session_state: st.session_state.city_selection = "–ú–æ—Å–∫–≤–∞"
if 'show_heatmap' not in st.session_state: st.session_state.show_heatmap = False
if 'fixed_gradient' not in st.session_state: st.session_state.fixed_gradient = False

# --- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ª–µ–≤–∞—è) ---
st.sidebar.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")

# 1. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–û–±—ã—á–Ω—ã–π / –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
settings_mode = st.sidebar.radio("–†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–∫:", ("–û–±—ã—á–Ω—ã–π", "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"), index=0)

# 2. –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã)
st.session_state.city_selection = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:", ("–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"), key='city_radio')
st.session_state.show_heatmap = st.sidebar.checkbox("–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É", key='heatmap_checkbox')

# 3. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π")
if settings_mode == "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π":
    st.sidebar.markdown("---")
    st.sidebar.subheader("–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:")

    st.session_state.min_score_filter = st.sidebar.slider("–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å POI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å–∫–æ—Ä–æ–º:", 0.0, 10000.0, float(st.session_state.min_score_filter), 100.0, key='min_score_slider')
    st.session_state.fixed_gradient = st.sidebar.checkbox("–§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–æ–≤–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç (0 - 10000)", st.session_state.fixed_gradient, key='fixed_gradient_checkbox')


    if not st.session_state.show_heatmap:
        st.sidebar.markdown("---")
        st.sidebar.markdown("**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤:**")
        st.session_state.radius_meters = st.sidebar.slider("–†–∞–¥–∏—É—Å –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ POI (–º–µ—Ç—Ä—ã):", 50, 500, st.session_state.radius_meters, step=50, key='radius_slider')
        st.session_state.fill_opacity_value = st.sidebar.slider("–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (0.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, 1.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π):", 0.0, 1.0, st.session_state.fill_opacity_value, 0.05, key='opacity_slider')
    else:
        st.sidebar.markdown("---")
        st.sidebar.markdown("**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**")
        st.session_state.heatmap_radius = st.sidebar.slider("–†–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —Ç–æ—á–µ–∫ –Ω–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–µ:", 5, 50, st.session_state.heatmap_radius, 5, key='hm_radius_slider')
        st.session_state.heatmap_blur = st.sidebar.slider("–†–∞–∑–º—ã—Ç–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 5, 50, st.session_state.heatmap_blur, 5, key='hm_blur_slider')
        st.session_state.heatmap_min_opacity = st.sidebar.slider("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 0.0, 1.0, st.session_state.heatmap_min_opacity, 0.1, key='hm_min_op_slider')
        st.session_state.heatmap_max_opacity = st.sidebar.slider("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 0.0, 1.0, st.session_state.heatmap_max_opacity, 0.1, key='hm_max_op_slider')

# 4. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–æ, –Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ)
st.sidebar.markdown("---")
with st.sidebar.expander("üìñ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"):
    st.markdown("""
    **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:**
    –≠—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ—á–∫–∞—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞ (POI) —Å **–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º –ø—Ä–æ–≥–Ω–æ–∑–æ–º –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ (—Å–∫–æ—Ä)**. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–∏–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏.

    **–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
    1.  **–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–∏–ø–æ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫—Ä—É–≥–∏ –∏–ª–∏ —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞).
    2.  **–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ª–µ–≤–∞—è):** –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

    ---

    **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–ª–µ–≤–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞):**

    **1. –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã):**

    * **–†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
        * **–û–±—ã—á–Ω—ã–π:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã.
        * **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π:** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
    * **–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:**
        * –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è **–ú–æ—Å–∫–≤—ã** –∏ **–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞**.
    * **–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É (—á–µ–∫–±–æ–∫—Å):**
        * –≠—Ç–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:
            * **–í–∫–ª—é—á–µ–Ω (–≥–∞–ª–æ—á–∫–∞ —Å—Ç–æ–∏—Ç):** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ **—Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã**. –≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ–±—â–µ–π "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã" –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –±–æ–ª—å—à–∏–º –æ–±–ª–∞—Å—Ç—è–º.
            * **–í—ã–∫–ª—é—á–µ–Ω (–≥–∞–ª–æ—á–∫–∏ –Ω–µ—Ç):** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ **–æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫—Ä—É–≥–æ–≤** –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞.
        * **–í–Ω–∏–º–∞–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∂–µ –º–µ–Ω—è—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ "–†–µ–∂–∏–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"!

    **2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"):**

    * **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å POI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å–∫–æ—Ä–æ–º:**
        * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä –æ—Ç 0 –¥–æ 10000.
        * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞, –æ—Ç–æ–±—Ä–∞–∂–∞—è —Ç–æ–ª—å–∫–æ —Ç–µ, —á–µ–π –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ —Ä–∞–≤–µ–Ω –∏–ª–∏ –≤—ã—à–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö.
    * **–§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–æ–≤–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç (0 - 10000):**
        * **–¢–∏–ø:** –ß–µ–∫–±–æ–∫—Å.
        * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ (–æ—Ç–º–µ—á–µ–Ω) —Ü–≤–µ—Ç –∫—Ä—É–≥–æ–≤ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –∏—Å—Ö–æ–¥—è –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–∫–æ—Ä–æ–≤ –æ—Ç 0 (–∫—Ä–∞—Å–Ω—ã–π) –¥–æ 10000 (–∑–µ–ª–µ–Ω—ã–π), –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø—Ä–∏–º–µ–Ω—è–µ–º–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å POI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å–∫–æ—Ä–æ–º". –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤–æ–π —à–∫–∞–ª—ã –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å–∫–æ—Ä—ã –º–µ–∂–¥—É —Å–æ–±–æ–π –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø–æ–¥ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω, –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ü–≤–µ—Ç–∞ –∫—Ä—É–≥–æ–≤ –±—É–¥–µ—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —Å–∫–æ—Ä–∞–º *–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö* POI.

    * **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ö—Ä—É–≥–∏" (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É" –í–´–ö–õ–Æ–ß–ï–ù):**
        * **–†–∞–¥–∏—É—Å –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ POI (–º–µ—Ç—Ä—ã):**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 50 –¥–æ 500 –º–µ—Ç—Ä–æ–≤).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–æ–Ω—É –≤–ª–∏—è–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ POI.
        * **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (0.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, 1.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π):**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å—Ç–µ–ø–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∫—Ä—É–≥–æ–≤.
                * **0.0:** –ö—Ä—É–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã (–Ω–µ–≤–∏–¥–∏–º—ã).
                * **1.0:** –ö—Ä—É–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã.
                * **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.3 –¥–æ 0.6, —á—Ç–æ–±—ã –∫—Ä—É–≥–∏ –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª–∏ –∏ –ø–æ–∑–≤–æ–ª—è–ª–∏ –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç—É –ø–æ–¥ –Ω–∏–º–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –º–µ—Å—Ç–∞—Ö –∏—Ö –Ω–∞–ª–æ–∂–µ–Ω–∏—è.
            * **–¶–≤–µ—Ç –∫—Ä—É–≥–æ–≤:** –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–∏–∑–∫–∏–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏, –∂–µ–ª—Ç—ã–π ‚Äî —Å—Ä–µ–¥–Ω–∏–π, –∑–µ–ª–µ–Ω—ã–π ‚Äî –≤—ã—Å–æ–∫–∏–π. –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –∫—Ä—É–≥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –µ–≥–æ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏.

    * **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞" (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É" –í–ö–õ–Æ–ß–ï–ù):**
        * **–†–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —Ç–æ—á–µ–∫ –Ω–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–µ:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 5 –¥–æ 50).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —à–∏—Ä–æ–∫–æ –∫–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ "—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç" —Å–≤–æ–π "–∂–∞—Ä" (—Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏) –ø–æ –∫–∞—Ä—Ç–µ. –ë–æ–ª—å—à–∏–π —Ä–∞–¥–∏—É—Å –¥–µ–ª–∞–µ—Ç —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –±–æ–ª–µ–µ –≥–ª–∞–¥–∫–æ–π –∏ –æ–±–æ–±—â–µ–Ω–Ω–æ–π, –º–µ–Ω—å—à–∏–π ‚Äî –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π.
        * **–†–∞–∑–º—ã—Ç–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 5 –¥–æ 50).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å—Ç–µ–ø–µ–Ω—å "—Ä–∞–∑–º—ã—Ç–æ—Å—Ç–∏" —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã. –ß–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–º–∏ –∏ –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –≥–æ—Ä—è—á–∏–º–∏ –∏ —Ö–æ–ª–æ–¥–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏.
        * **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º—ã—Ö "—Ö–æ–ª–æ–¥–Ω—ã—Ö" (–º–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω—ã—Ö) –æ–±–ª–∞—Å—Ç–µ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã.
        * **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º—ã—Ö "–≥–æ—Ä—è—á–∏—Ö" (–Ω–∞–∏–±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã—Ö) –æ–±–ª–∞—Å—Ç–µ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã.
            * **–¶–≤–µ—Ç —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ: **–ö—Ä–∞—Å–Ω—ã–µ** –æ–±–ª–∞—Å—Ç–∏ –æ–∑–Ω–∞—á–∞—é—Ç –Ω–∏–∑–∫–∏–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏, **–∂–µ–ª—Ç—ã–µ** ‚Äî —Å—Ä–µ–¥–Ω–∏–π, **–∑–µ–ª–µ–Ω—ã–µ** ‚Äî –≤—ã—Å–æ–∫–∏–π. –ß–µ–º —è—Ä—á–µ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–µ–µ –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç, —Ç–µ–º –≤—ã—à–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –≤—ã–≥–æ–¥–∞ –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.
    """)

# --- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã ---
@st.cache_data(show_spinner=False)
def get_folium_map(current_city_selection, current_show_heatmap, current_min_score_filter,
                   current_radius_meters, current_fill_opacity_value,
                   current_heatmap_radius, current_heatmap_blur, current_heatmap_min_opacity, current_heatmap_max_opacity,
                   current_fixed_gradient,
                   pois_df):

    if current_city_selection == "–ú–æ—Å–∫–≤–∞":
        map_center = [55.7558, 37.6173]
    else:
        map_center = [59.9343, 30.3351]
    zoom_start = 10

    m = folium.Map(location=map_center, zoom_start=zoom_start, tiles="OpenStreetMap")

    filtered_pois_df = pois_df[pois_df['score'] >= current_min_score_filter].copy()

    if not filtered_pois_df.empty:
        min_displayed_score = filtered_pois_df['score'].min()
        max_displayed_score = filtered_pois_df['score'].max()
        
        color_min_score = 0.0
        color_max_score = 10000.0 
        if not current_fixed_gradient:
            color_min_score = min_displayed_score
            color_max_score = max_displayed_score
            if color_min_score == color_max_score:
                color_min_score = 0.0
                color_max_score = 10000.0

        if current_show_heatmap:
            heat_data = filtered_pois_df[['latitude', 'longitude', 'score']].values.tolist()
            if max_displayed_score > 0:
                scaled_heat_data = [[lat, lon, score / max_displayed_score] for lat, lon, score in heat_data]
            else:
                scaled_heat_data = heat_data

            custom_gradient = {0.0: 'red', 0.5: 'yellow', 1.0: 'green'}
            HeatMap(scaled_heat_data,
                    radius=current_heatmap_radius,
                    blur=current_heatmap_blur,
                    min_opacity=current_heatmap_min_opacity,
                    max_opacity=current_heatmap_max_opacity,
                    gradient=custom_gradient
                    ).add_to(m)
        else:
            for index, row in filtered_pois_df.iterrows():
                lat, lon = row['latitude'], row['longitude']
                score = row['score']
                
                color = get_gradient_color(score, color_min_score, color_max_score)
                folium.Circle(
                    location=[lat, lon],
                    radius=current_radius_meters,
                    color=color,
                    weight=0,
                    fill=True,
                    fill_color=color,
                    fill_opacity=current_fill_opacity_value,
                    tooltip=f"–ü—Ä–æ–≥–Ω–æ–∑ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏: {score:.0f}"
                ).add_to(m)
    return m

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã ---
current_city = st.session_state.city_selection
if current_city == "–ú–æ—Å–∫–≤–∞":
    filepath = "moscow_pois.csv"
else:
    filepath = "spb_pois.csv"

try:
    current_pois_df = load_and_process_pois(filepath)
    st.info(f"–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {current_city} –∏–∑ —Ñ–∞–π–ª–∞ '{filepath}'...")
    st.success(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(current_pois_df)} —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –¥–ª—è {current_city}.")
except FileNotFoundError:
    st.error(f"–§–∞–π–ª '{filepath}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, —á—Ç–æ –∏ –≤–∞—à —Å–∫—Ä–∏–ø—Ç Streamlit.")
    st.stop()
except Exception as e:
    st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
    st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–æ–ª–±—Ü—ã 'lat', 'lon' –∏ 'score'.")
    st.stop()


st.write(f"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è {len(current_pois_df[current_pois_df['score'] >= st.session_state.min_score_filter])} —Ç–æ—á–µ–∫ –∏–∑ {len(current_pois_df)} (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å–∫–æ—Ä—É).")


# –í—ã–∑—ã–≤–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –∫–∞—Ä—Ç—ã
m = get_folium_map(st.session_state.city_selection,
                   st.session_state.show_heatmap,
                   st.session_state.min_score_filter,
                   st.session_state.radius_meters,
                   st.session_state.fill_opacity_value,
                   st.session_state.heatmap_radius,
                   st.session_state.heatmap_blur,
                   st.session_state.heatmap_min_opacity,
                   st.session_state.heatmap_max_opacity,
                   st.session_state.fixed_gradient,
                   current_pois_df)

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π
st.subheader(f"{st.session_state.city_selection}: –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å –∫–æ—Ñ–µ–µ–Ω –≤–æ–∫—Ä—É–≥ POI")
st.markdown("---")

# –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
if not current_pois_df[current_pois_df['score'] >= st.session_state.min_score_filter].empty:
    if st.session_state.show_heatmap:
        st.markdown(f"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ **—Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ POI.")
        st.markdown("–¶–≤–µ—Ç —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏:")
        st.markdown("- **–ö—Ä–∞—Å–Ω—ã–π**: –ú–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("- **–ñ–µ–ª—Ç—ã–π**: –°—Ä–µ–¥–Ω—è—è –≤—ã–≥–æ–¥–Ω–æ—Å—Ç—å")
        st.markdown("- **–ó–µ–ª–µ–Ω—ã–π**: –û—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("–ë–æ–ª–µ–µ —è—Ä–∫–∏–µ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤—ã–≥–æ–¥–Ω—ã—Ö POI.")
    else:
        st.markdown(f"–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã **–∫—Ä—É–≥–∏** —Ä–∞–¥–∏—É—Å–æ–º **{st.session_state.radius_meters} –º–µ—Ç—Ä–æ–≤** –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞.")
        st.markdown("–¶–≤–µ—Ç –∫—Ä—É–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏:")
        st.markdown("- **–ö—Ä–∞—Å–Ω—ã–π**: –ú–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("- **–ñ–µ–ª—Ç—ã–π**: –°—Ä–µ–¥–Ω—è—è –≤—ã–≥–æ–¥–Ω–æ—Å—Ç—å")
        st.markdown("- **–ó–µ–ª–µ–Ω—ã–π**: –û—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown(f"–¢–µ–∫—É—â–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (–Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å): **{st.session_state.fill_opacity_value:.2f}**")
        if st.session_state.fixed_gradient:
            st.markdown("*–¶–≤–µ—Ç–æ–≤–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫—Ä—É–≥–æ–≤ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –æ—Ç 0 (–∫—Ä–∞—Å–Ω—ã–π) –¥–æ 10000 (–∑–µ–ª–µ–Ω—ã–π).*")
        else:
            st.markdown("*–¶–≤–µ—Ç–æ–≤–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫—Ä—É–≥–æ–≤ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É —Å–∫–æ—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö POI.*")
else:
    st.warning("–ù–µ—Ç —Ç–æ—á–µ–∫ POI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.")


folium_figure = folium.Figure(width=900, height=520)
folium_figure.add_child(m)
st.components.v1.html(folium_figure._repr_html_(), height=540, scrolling=False)
