import streamlit as st
import folium
import numpy as np
import pandas as pd
import random
from shapely import wkt
from folium.plugins import HeatMap

# --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
st.set_page_config(layout="wide")
st.title("–ö–∞—Ä—Ç–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è POI")
st.write("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω –≤–æ–∫—Ä—É–≥ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (POI) –∏–∑ OpenStreetMap.")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Å–∫–æ—Ä–∞ –º–æ–¥–µ–ª–∏ ---
@st.cache_data
def get_model_score(lat, lon, poi_type=None):
    """
    –ò–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–æ—Ä–∞ –æ—Ç –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—á–∫–∏.
    –°–∫–æ—Ä –æ—Ç 0 (–Ω–µ–≤—ã–≥–æ–¥–Ω–æ) –¥–æ 1 (–æ—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω–æ).
    """
    base_score = random.uniform(0.1, 0.9)

    if poi_type in ['subway_station', 'bus_stop', 'university', 'mall', 'restaurant', 'cafe', 'bar']:
        base_score += random.uniform(0.1, 0.2)

    return min(1.0, max(0.0, base_score))

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö POI ---
@st.cache_data
def load_and_process_pois(filepath):
    df = pd.read_csv(filepath)

    def get_coords_from_wkt(wkt_string):
        try:
            geom = wkt.loads(wkt_string)
            
            if geom.geom_type == 'Point':
                return geom.y, geom.x 
            elif geom.geom_type in ['Polygon', 'LineString', 'MultiPoint', 'MultiPolygon', 'MultiLineString']:
                centroid = geom.centroid
                return centroid.y, centroid.x
            else:
                return None, None
        except Exception as e:
            return None, None

    df[['latitude', 'longitude']] = df['geometry'].apply(lambda x: pd.Series(get_coords_from_wkt(x)))

    type_columns = ['amenity', 'shop', 'leisure', 'building', 'tourism', 'office', 'healthcare', 'sport', 'natural', 'craft', 'historic', 'landuse', 'public_transport'] 
    
    existing_type_columns = [col for col in type_columns if col in df.columns]
    
    if existing_type_columns:
        df['poi_type'] = df[existing_type_columns].bfill(axis=1).iloc[:, 0]
    else:
        df['poi_type'] = 'unknown'

    df['poi_type'] = df['poi_type'].fillna('other')

    df = df.dropna(subset=['latitude', 'longitude'])

    df['score'] = df.apply(lambda row: get_model_score(row['latitude'], row['longitude'], row['poi_type']), axis=1)

    return df

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ø–æ —Å–∫–æ—Ä—É (–¥–ª—è –∫—Ä—É–≥–æ–≤) ---
def get_gradient_color(score, min_score, max_score):
    if max_score == min_score:
        normalized_score = 0.5
    else:
        normalized_score = (score - min_score) / (max_score - min_score)

    if normalized_score < 0.5:
        r = 1
        g = normalized_score * 2
        b = 0
    else:
        r = 1 - (normalized_score - 0.5) * 2
        g = 1
        b = 0
    return f'#{int(r*255):02x}{int(g*255):02x}{int(b*255):02x}'


# --- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ª–µ–≤–∞—è) ---
st.sidebar.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")

# 1. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–û–±—ã—á–Ω—ã–π / –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
settings_mode = st.sidebar.radio("–†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–∫:", ("–û–±—ã—á–Ω—ã–π", "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"), index=0)

# 2. –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã)
city_selection = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:", ("–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"), index=0)
show_heatmap = st.sidebar.checkbox("–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É", False)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –±—É–¥—É—Ç –∑–∞–¥–∞–Ω—ã –≤ "–û–±—ã—á–Ω–æ–º" —Ä–µ–∂–∏–º–µ
# –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ "–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º" —Ä–µ–∂–∏–º–µ
radius_meters = 150
fill_opacity_value = 0.4
heatmap_radius = 20
heatmap_blur = 15
heatmap_min_opacity = 0.3
heatmap_max_opacity = 0.8
min_score_filter = 0.1

# 3. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π")
if settings_mode == "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π":
    st.sidebar.markdown("---") # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    st.sidebar.subheader("–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:")

    # –§–∏–ª—å—Ç—Ä –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É —Å–∫–æ—Ä—É - —Ç–µ–ø–µ—Ä—å –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö
    min_score_filter = st.sidebar.slider("–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å POI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å–∫–æ—Ä–æ–º:", 0.0, 1.0, 0.1, 0.05)

    if not show_heatmap: # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤
        st.sidebar.markdown("---")
        st.sidebar.markdown("**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤:**")
        radius_meters = st.sidebar.slider("–†–∞–¥–∏—É—Å –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ POI (–º–µ—Ç—Ä—ã):", 50, 500, 150, step=50)
        fill_opacity_value = st.sidebar.slider("–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (0.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, 1.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π):", 0.0, 1.0, 0.4, 0.05)
    else: # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
        st.sidebar.markdown("---")
        st.sidebar.markdown("**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**")
        heatmap_radius = st.sidebar.slider("–†–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —Ç–æ—á–µ–∫ –Ω–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–µ:", 5, 50, 20, 5)
        heatmap_blur = st.sidebar.slider("–†–∞–∑–º—ã—Ç–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 5, 50, 15, 5)
        heatmap_min_opacity = st.sidebar.slider("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 0.0, 1.0, 0.3, 0.1)
        heatmap_max_opacity = st.sidebar.slider("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:", 0.0, 1.0, 0.8, 0.1)

# 4. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–æ, –Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ)
st.sidebar.markdown("---")
with st.sidebar.expander("üìñ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"):
    st.markdown("""
    **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:**
    –≠—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ñ–µ–µ–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ—á–∫–∞—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞ (POI) –∏–∑ OpenStreetMap –∏ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø—Ä–æ–≥–Ω–æ–∑–µ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–∏–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏.

    **–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
    1.  **–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–∏–ø–æ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫—Ä—É–≥–∏ –∏–ª–∏ —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞).
    2.  **–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ª–µ–≤–∞—è):** –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

    ---

    **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–ª–µ–≤–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞):**

    **1. –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã):**

    * **–†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
        * **–û–±—ã—á–Ω—ã–π:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã.
        * **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π:** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
    * **–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:**
        * –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è **–ú–æ—Å–∫–≤—ã** –∏ **–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞**.
    * **–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É (—á–µ–∫–±–æ–∫—Å):**
        * –≠—Ç–æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:
            * **–í–∫–ª—é—á–µ–Ω (–≥–∞–ª–æ—á–∫–∞ —Å—Ç–æ–∏—Ç):** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ **—Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã**. –≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ–±—â–µ–π "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã" –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –±–æ–ª—å—à–∏–º –æ–±–ª–∞—Å—Ç—è–º.
            * **–í—ã–∫–ª—é—á–µ–Ω (–≥–∞–ª–æ—á–∫–∏ –Ω–µ—Ç):** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∂–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ **–æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫—Ä—É–≥–æ–≤** –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞.
        * **–í–Ω–∏–º–∞–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∂–µ –º–µ–Ω—è—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ "–†–µ–∂–∏–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫"!

    **2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π"):**

    * **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å POI —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å–∫–æ—Ä–æ–º:**
        * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä –æ—Ç 0.0 –¥–æ 1.0.
        * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞, –æ—Ç–æ–±—Ä–∞–∂–∞—è —Ç–æ–ª—å–∫–æ —Ç–µ, —á–µ–π –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ —Ä–∞–≤–µ–Ω –∏–ª–∏ –≤—ã—à–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ "–≤—ã–≥–æ–¥–Ω—ã–µ" –º–µ—Å—Ç–∞, —É–≤–µ–ª–∏—á—å—Ç–µ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è "—à—É–º–∞" –Ω–∞ –∫–∞—Ä—Ç–µ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö, –∞ —Ç–∞–∫–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å –ø–µ—Ä–µ–≥—Ä–µ–≤ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –≤ –æ–±–ª–∞—Å—Ç—è—Ö —Å –≤—ã—Å–æ–∫–æ–π, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π" –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é.

    * **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ö—Ä—É–≥–∏" (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É" –í–´–ö–õ–Æ–ß–ï–ù):**
        * **–†–∞–¥–∏—É—Å –æ–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ POI (–º–µ—Ç—Ä—ã):**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 50 –¥–æ 500 –º–µ—Ç—Ä–æ–≤).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–æ–Ω—É –≤–ª–∏—è–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ POI.
        * **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (0.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, 1.0 - –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π):**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å—Ç–µ–ø–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∫—Ä—É–≥–æ–≤.
                * **0.0:** –ö—Ä—É–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã (–Ω–µ–≤–∏–¥–∏–º—ã).
                * **1.0:** –ö—Ä—É–≥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã.
                * **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.3 –¥–æ 0.6, —á—Ç–æ–±—ã –∫—Ä—É–≥–∏ –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª–∏ –∏ –ø–æ–∑–≤–æ–ª—è–ª–∏ –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç—É –ø–æ–¥ –Ω–∏–º–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –º–µ—Å—Ç–∞—Ö –∏—Ö –Ω–∞–ª–æ–∂–µ–Ω–∏—è.
            * **–¶–≤–µ—Ç –∫—Ä—É–≥–æ–≤:** –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–∏–∑–∫–∏–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏, –∂–µ–ª—Ç—ã–π ‚Äî —Å—Ä–µ–¥–Ω–∏–π, –∑–µ–ª–µ–Ω—ã–π ‚Äî –≤—ã—Å–æ–∫–∏–π. –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –∫—Ä—É–≥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –µ–≥–æ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏.

    * **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞" (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É" –í–ö–õ–Æ–ß–ï–ù):**
        * **–†–∞–¥–∏—É—Å –≤–ª–∏—è–Ω–∏—è —Ç–æ—á–µ–∫ –Ω–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç–µ:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 5 –¥–æ 50).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —à–∏—Ä–æ–∫–æ –∫–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ "—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç" —Å–≤–æ–π "–∂–∞—Ä" (—Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏) –ø–æ –∫–∞—Ä—Ç–µ. –ë–æ–ª—å—à–∏–π —Ä–∞–¥–∏—É—Å –¥–µ–ª–∞–µ—Ç —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –±–æ–ª–µ–µ –≥–ª–∞–¥–∫–æ–π –∏ –æ–±–æ–±—â–µ–Ω–Ω–æ–π, –º–µ–Ω—å—à–∏–π ‚Äî –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π.
        * **–†–∞–∑–º—ã—Ç–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 5 –¥–æ 50).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å—Ç–µ–ø–µ–Ω—å "—Ä–∞–∑–º—ã—Ç–æ—Å—Ç–∏" —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã. –ß–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–º–∏ –∏ –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –≥–æ—Ä—è—á–∏–º–∏ –∏ —Ö–æ–ª–æ–¥–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏.
        * **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º—ã—Ö "—Ö–æ–ª–æ–¥–Ω—ã—Ö" (–º–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω—ã—Ö) –æ–±–ª–∞—Å—Ç–µ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã.
        * **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:**
            * **–¢–∏–ø:** –°–ª–∞–π–¥–µ—Ä (–æ—Ç 0.0 –¥–æ 1.0).
            * **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º—ã—Ö "–≥–æ—Ä—è—á–∏—Ö" (–Ω–∞–∏–±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã—Ö) –æ–±–ª–∞—Å—Ç–µ–π —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã.
            * **–¶–≤–µ—Ç —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ: **–ö—Ä–∞—Å–Ω—ã–µ** –æ–±–ª–∞—Å—Ç–∏ –æ–∑–Ω–∞—á–∞—é—Ç –Ω–∏–∑–∫–∏–π —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏, **–∂–µ–ª—Ç—ã–µ** ‚Äî —Å—Ä–µ–¥–Ω–∏–π, **–∑–µ–ª–µ–Ω—ã–µ** ‚Äî –≤—ã—Å–æ–∫–∏–π. –ß–µ–º —è—Ä—á–µ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–µ–µ –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç, —Ç–µ–º –≤—ã—à–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –≤—ã–≥–æ–¥–∞ –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏.
    """)

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã ---
if city_selection == "–ú–æ—Å–∫–≤–∞":
    filepath = "moscow_pois.csv"
    map_center = [55.7558, 37.6173]
    zoom_start = 10
    map_title = "–ú–æ—Å–∫–≤–∞: –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å –∫–æ—Ñ–µ–µ–Ω –≤–æ–∫—Ä—É–≥ POI (–∏–∑ OSMnx, –≤—Å–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏)"
else:
    filepath = "spb_pois.csv"
    map_center = [59.9343, 30.3351]
    zoom_start = 11
    map_title = "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥: –í—ã–≥–æ–¥–Ω–æ—Å—Ç—å –∫–æ—Ñ–µ–µ–Ω –≤–æ–∫—Ä—É–≥ POI (–∏–∑ OSMnx)"

filtered_pois_df = pd.DataFrame()
pois_df = pd.DataFrame()

st.info(f"–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {city_selection} –∏–∑ —Ñ–∞–π–ª–∞ '{filepath}'...")
try:
    pois_df = load_and_process_pois(filepath)
    st.success(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(pois_df)} —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –¥–ª—è {city_selection}.")

    if not pois_df.empty:
        filtered_pois_df = pois_df[pois_df['score'] >= min_score_filter].copy()
    else:
        st.warning("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö.")

    st.write(f"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è {len(filtered_pois_df)} —Ç–æ—á–µ–∫ –∏–∑ {len(pois_df)} (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å–∫–æ—Ä—É).")

except FileNotFoundError:
    st.error(f"–§–∞–π–ª '{filepath}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, —á—Ç–æ –∏ –≤–∞—à —Å–∫—Ä–∏–ø—Ç Streamlit.")
except Exception as e:
    st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
    st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤.")


m = folium.Map(location=map_center, zoom_start=zoom_start, tiles="OpenStreetMap")

st.subheader(map_title)
st.markdown("---")

if not filtered_pois_df.empty:
    min_overall_score = filtered_pois_df['score'].min()
    max_overall_score = filtered_pois_df['score'].max()

    if min_overall_score == max_overall_score:
        min_overall_score = 0.0
        max_overall_score = 1.0

    if show_heatmap:
        heat_data = filtered_pois_df[['latitude', 'longitude', 'score']].values.tolist()
        
        custom_gradient = {0.0: 'red', 0.5: 'yellow', 1.0: 'green'}

        HeatMap(heat_data,
                radius=heatmap_radius,
                blur=heatmap_blur,
                min_opacity=heatmap_min_opacity,
                max_opacity=heatmap_max_opacity,
                gradient=custom_gradient
                ).add_to(m)

        st.markdown(f"–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ **—Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–∞ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ POI.")
        st.markdown("–¶–≤–µ—Ç —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏:")
        st.markdown("- **–ö—Ä–∞—Å–Ω—ã–π**: –ú–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("- **–ñ–µ–ª—Ç—ã–π**: –°—Ä–µ–¥–Ω—è—è –≤—ã–≥–æ–¥–Ω–æ—Å—Ç—å")
        st.markdown("- **–ó–µ–ª–µ–Ω—ã–π**: –û—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("–ë–æ–ª–µ–µ —è—Ä–∫–∏–µ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤—ã–≥–æ–¥–Ω—ã—Ö POI.")
    else:
        for index, row in filtered_pois_df.iterrows():
            lat, lon = row['latitude'], row['longitude']
            score = row['score']
            name = row['name'] if pd.notna(row['name']) else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π POI"
            poi_type = row['poi_type']

            color = get_gradient_color(score, min_overall_score, max_overall_score)

            folium.Circle(
                location=[lat, lon],
                radius=radius_meters,
                color=color,
                weight=0,
                fill=True,
                fill_color=color,
                fill_opacity=fill_opacity_value,
                tooltip=f"–ü—Ä–æ–≥–Ω–æ–∑ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏: {score:.2f}"
            ).add_to(m)

        st.markdown(f"–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã **–∫—Ä—É–≥–∏** —Ä–∞–¥–∏—É—Å–æ–º **{radius_meters} –º–µ—Ç—Ä–æ–≤** –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞.")
        st.markdown("–¶–≤–µ—Ç –∫—Ä—É–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ—Ä –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏:")
        st.markdown("- **–ö—Ä–∞—Å–Ω—ã–π**: –ú–µ–Ω–µ–µ –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown("- **–ñ–µ–ª—Ç—ã–π**: –°—Ä–µ–¥–Ω—è—è –≤—ã–≥–æ–¥–Ω–æ—Å—Ç—å")
        st.markdown("- **–ó–µ–ª–µ–Ω—ã–π**: –û—á–µ–Ω—å –≤—ã–≥–æ–¥–Ω–æ")
        st.markdown(f"–¢–µ–∫—É—â–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫—Ä—É–≥–æ–≤ (–Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å): **{fill_opacity_value:.2f}**")

else:
    st.warning("–ù–µ—Ç —Ç–æ—á–µ–∫ POI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.")

folium_figure = folium.Figure(width=900, height=520)
folium_figure.add_child(m)
st.components.v1.html(folium_figure._repr_html_(), height=540, scrolling=False)
